<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local SFTP Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #111827;
            --bg-medium: #1f2937;
            --bg-light: #374151;
            --text-light: #f9fafb;
            --text-medium: #e5e7eb;
            --text-muted: #9ca3af;
            --border-dark: #1f2937;
            --border-medium: #374151;
            --border-light: #4b5563;
            --radius: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.25);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 6px 10px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background-color: var(--bg-medium);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            background-color: var(--bg-medium);
        }

        /* Loader styles */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading-button {
            position: relative;
        }

        .loading-button .loader {
            position: absolute;
            left: 50%;
            top: 50%;
            margin-top: -10px;
            margin-left: -10px;
        }

        .loading-button span {
            visibility: hidden;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .card-body {
            padding: 1.5rem;
        }

        .connection-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-medium);
        }

        .form-input {
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background-color: var(--bg-light);
            font-size: 0.875rem;
            color: var(--text-light);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0d9668;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-medium);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background-color: var(--bg-dark);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            background-color: var(--bg-light);
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .connection-status.connected {
            background-color: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .filesystem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .path-display {
            font-family: "Roboto Mono", monospace;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            background-color: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            color: var(--text-medium);
            overflow-x: auto;
            white-space: nowrap;
            flex: 1;
            margin-right: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .file-explorer {
            height: 400px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 1.5rem;
            background-color: var(--bg-light);
        }

        .file-list {
            height: 100%;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-medium);
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .file-item:hover {
            background-color: var(--bg-medium);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item.dir {
            color: var(--primary-light);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-name {
            font-size: 0.875rem;
        }

        .file-icon {
            font-size: 1rem;
            width: 1.5rem;
            text-align: center;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .item-actions .btn {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        .upload-section {
            border-top: 1px solid var(--border-light);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .upload-form {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .upload-input-wrapper {
            flex: 1;
            position: relative;
        }

        .upload-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background-color: var(--bg-light);
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .status-section {
            margin-top: 1.5rem;
        }

        .status-area {
            height: 120px;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            background-color: var(--bg-light);
            font-family: "Roboto Mono", monospace;
            font-size: 0.75rem;
            overflow-y: auto;
            color: var(--text-medium);
        }

        .status-area p {
            margin-bottom: 0.5rem;
        }

        .success-message {
            color: var(--success);
        }

        .error-message {
            color: var(--danger);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .directory-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            margin-bottom: 1rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--gray-800);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .connection-form {
                grid-template-columns: 1fr;
            }

            .filesystem-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .path-display {
                width: 100%;
                margin-right: 0;
            }

            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .upload-form {
                flex-direction: column;
                align-items: flex-start;
            }

            .upload-input-wrapper {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Local SFTP Client</h1>
                <div id="connectionStatus" class="connection-status">
                    <i class="fas fa-times-circle"></i>
                    <span>Not connected</span>
                </div>
            </div>

            <div class="card-body">
                <div class="connection-form">
                    <div class="form-group">
                        <label for="hostIp" class="form-label">Host Address</label>
                        <input type="text" id="hostIp" class="form-input"
                            placeholder="hostname or IP (e.g., 192.168.1.1:22)" value="10.220.120.17" />
                    </div>
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-input" placeholder="Username"
                            value="karan-connect" />
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-input" placeholder="Password"
                            value="karanVAC" />
                    </div>
                    <div class="form-group" style="justify-content: flex-end">
                        <button id="connectBtn" class="btn btn-primary">
                            <div class="loader" style="display: none"></div>
                            <span>
                                <i class="fas fa-plug"></i>
                                Connect
                            </span>
                        </button>
                    </div>
                </div>

                <div class="filesystem-section">
                    <div class="filesystem-header">
                        <div class="path-display" id="currentPath">/</div>
                        <div class="action-buttons">
                            <button id="upDirBtn" class="btn btn-secondary">
                                <div class="loader" style="display: none"></div>
                                <span>
                                    <i class="fas fa-arrow-up"></i>
                                    Up
                                </span>
                            </button>
                            <button id="newFolderBtn" class="btn btn-secondary">
                                <div class="loader" style="display: none"></div>
                                <span>
                                    <i class="fas fa-folder-plus"></i>
                                    New Folder
                                </span>
                            </button>
                            <button id="refreshBtn" class="btn btn-secondary">
                                <div class="loader" style="display: none"></div>
                                <span>
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </span>
                            </button>
                        </div>
                    </div>

                    <div class="directory-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="dirStats">Connect to a server to browse files</span>
                    </div>

                    <div class="file-explorer">
                        <div class="file-list" id="fileList">
                            <div class="file-item">
                                <div class="file-info">
                                    <i class="fas fa-server file-icon"></i>
                                    <span class="file-name">Connect to a server to view files</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="upload-section">
                    <h2 class="section-title">Upload File</h2>
                    <form id="uploadForm" class="upload-form">
                        <div class="upload-input-wrapper">
                            <input type="file" id="fileUpload" class="upload-input" />
                        </div>
                        <button type="submit" class="btn btn-success" id="uploadBtn">
                            <div class="loader" style="display: none"></div>
                            <span>
                                <i class="fas fa-upload"></i>
                                Upload
                            </span>
                        </button>
                    </form>
                </div>

                <div id="terminal" style="margin-top: 1.5rem">
                    <h2 class="section-title">Terminal</h2>
                    <button id="connectTerminalBtn" class="btn btn-primary" style="margin-bottom: 1rem">
                        <i class="fas fa-terminal"></i> Connect Terminal
                    </button>
                    <div id="terminalContainer" style="
                height: 300px;
                border: 1px solid var(--border-light);
                border-radius: var(--radius);
              "></div>
                </div>

                <div class="status-section">
                    <h2 class="section-title">Status Log</h2>
                    <div class="status-area" id="statusArea">
                        <p>Ready to connect. Please enter server details and connect.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPath = '/';
        let isConnected = false;
        let connectionInfo = {};
        let term = null;
        let fitAddon = null;
        let termSocket = null;

        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const upDirBtn = document.getElementById('upDirBtn');
        const newFolderBtn = document.getElementById('newFolderBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileList = document.getElementById('fileList');
        const currentPathDisplay = document.getElementById('currentPath');
        const uploadForm = document.getElementById('uploadForm');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusArea = document.getElementById('statusArea');
        const dirStats = document.getElementById('dirStats');
        const connectTerminalBtn = document.getElementById('connectTerminalBtn');

        // Event listeners
        connectBtn.addEventListener('click', connect);
        upDirBtn.addEventListener('click', navigateUp);
        newFolderBtn.addEventListener('click', createNewFolder);
        refreshBtn.addEventListener('click', refreshFileList);
        uploadForm.addEventListener('submit', uploadFile);
        connectTerminalBtn.addEventListener('click', connectTerminal);

        // Initialize terminal
        function initTerminal() {
            if (!term) {
                // Create a new terminal instance with improved settings
                term = new Terminal({
                    cursorBlink: true,
                    theme: {
                        background: 'var(--bg-medium)',
                        foreground: 'var(--text-light)'
                    },
                    fontFamily: '"Roboto Mono", monospace',
                    fontSize: 14,
                    lineHeight: 1.2,            // Better line spacing
                    cols: 100,                  // Wider default size to reduce wrapping
                    rows: 24,                   // Standard terminal height
                    scrollback: 1000,           // More scrollback
                    rendererType: 'canvas',     // Better rendering
                    allowTransparency: false,   // Improves performance
                    convertEol: true            // Convert line feed characters to CRLF
                });

                // Load the fit addon
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                // Open terminal in the container
                term.open(document.getElementById('terminalContainer'));

                // Initial sizing - important for proper display
                setTimeout(() => {
                    fitAddon.fit();
                    console.log(`Terminal sized to ${term.cols}x${term.rows}`);
                }, 100);

                // Handle window resize with debouncing for better performance
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        fitAddon.fit();
                        // Send size to server (handled in onResize event)
                    }, 100);
                });

                // Initial terminal message
                term.write("Terminal ready. Click 'Connect Terminal' to start a session.\r\n");

                // Add click event to focus terminal
                document.getElementById('terminalContainer').addEventListener('click', () => {
                    term.focus();
                });
            }
        }

        // Connect terminal to SSH server
        function connectTerminal() {
            // Check if connected to a server
            const connectBtn = document.getElementById('connectTerminalBtn');

            // Prevent multiple connections - check if we're already connecting
            if (connectBtn.disabled) {
                return; // Already in progress
            }

            if (!isConnected) {
                showStatus("Please connect to a server first", "error");
                updateTerminalStatus('error', 'Not connected to server');
                return;
            }

            // If already connected, disconnect first
            if (termSocket && termSocket.readyState === WebSocket.OPEN) {
                showStatus("Already connected. Disconnecting first...", "");
                termSocket.close();
                termSocket = null;
                return; // Exit and let the onclose handler trigger the reconnect
            }

            // Disable the connect button during connection
            connectBtn.disabled = true;

            // Make sure terminal is initialized
            if (!term) {
                initTerminal();
            } else {
                term.clear();
            }

            // Write connecting message
            term.write("Connecting to SSH server...\r\n");

            // Get host and port from the connection info
            let host, port;
            if (connectionInfo.hostIp.includes(':')) {
                [host, port] = connectionInfo.hostIp.split(':');
            } else {
                host = connectionInfo.hostIp;
                port = 22;
            }

            // Get credentials
            const username = connectionInfo.username;
            const password = document.getElementById('password').value;

            // Create WebSocket URL with credentials
            const wsUrl = `ws://${window.location.hostname}:8888/terminal?host=${encodeURIComponent(host)}&port=${encodeURIComponent(port)}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;

            try {
                showStatus(`Connecting terminal to ${host}:${port} as ${username}...`, '');

                // Create WebSocket connection
                termSocket = new WebSocket(wsUrl);
                termSocket.binaryType = 'arraybuffer';

                // Handle WebSocket events
                termSocket.onopen = () => {
                    showStatus("Terminal connected successfully", "success");
                    term.write("\r\n\x1B[1;32mConnected to SSH server\x1B[0m\r\n");

                    // Send initial terminal size
                    sendTerminalSize(term.cols, term.rows);

                    // Perform an initial fit after connection
                    setTimeout(() => {
                        fitAddon.fit();
                        sendTerminalSize(term.cols, term.rows);
                    }, 500);
                };

                termSocket.onmessage = (event) => {
                    // Convert binary data to string if needed
                    const data = typeof event.data === 'string'
                        ? event.data
                        : new TextDecoder().decode(event.data);
                    term.write(data);
                };

                termSocket.onerror = (error) => {
                    console.error("Terminal WebSocket error:", error);
                    showStatus("Terminal connection error", "error");
                    term.write("\r\n\x1B[1;31mConnection error\x1B[0m\r\n");
                };

                termSocket.onclose = () => {
                    showStatus("Terminal connection closed", "error");
                    term.write("\r\n\x1B[1;31mConnection closed\x1B[0m\r\n");
                    termSocket = null;
                };

                // Forward terminal input to SSH server
                term.onData((data) => {
                    if (termSocket && termSocket.readyState === WebSocket.OPEN) {
                        termSocket.send(data);
                    }
                });

                // Handle terminal resize and send updated dimensions to server
                term.onResize(({ cols, rows }) => {
                    sendTerminalSize(cols, rows);
                });

            } catch (error) {
                console.error("Error connecting terminal:", error);
                showStatus(`Terminal connection failed: ${error.message}`, "error");
                term.write(`\r\n\x1B[1;31mConnection error: ${error.message}\x1B[0m\r\n`);
            }
        }

        // Send terminal size to the server
        function sendTerminalSize(cols, rows) {
            if (termSocket && termSocket.readyState === WebSocket.OPEN) {
                console.log(`Sending terminal size: ${cols}x${rows}`);

                // Send resize information as JSON
                try {
                    termSocket.send(JSON.stringify({
                        type: 'resize',
                        cols: cols,
                        rows: rows
                    }));
                } catch (e) {
                    console.error("Error sending terminal resize info:", e);
                }
            }
        }

        // Utility function to show a button is loading
        function setButtonLoading(button, isLoading) {
            const loader = button.querySelector('.loader');
            const span = button.querySelector('span');

            if (isLoading) {
                loader.style.display = 'inline-block';
                button.classList.add('loading-button');
                span.style.visibility = 'hidden';
            } else {
                loader.style.display = 'none';
                button.classList.remove('loading-button');
                span.style.visibility = 'visible';
            }
        }

        // Show loading overlay for the file list
        function setFileListLoading(isLoading) {
            if (isLoading) {
                fileList.classList.add('loading');
                fileList.innerHTML = `
                          <div class="file-item" style="justify-content: center; padding: 2rem;">
                              <div class="loader"></div>
                              <span style="margin-left: 0.75rem;">Loading files...</span>
                          </div>
                      `;
            } else {
                fileList.classList.remove('loading');
            }
        }

        // Connect to server
        async function connect() {
            const hostIp = document.getElementById('hostIp').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!hostIp || !username || !password) {
                showStatus('Please fill in all connection fields', 'error');
                return;
            }

            try {
                // Show loading state
                setButtonLoading(connectBtn, true);
                showStatus(`Attempting to connect to ${hostIp} as ${username}...`, '');

                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hostIp, username, password })
                });

                const result = await response.json();

                // Hide loading state
                setButtonLoading(connectBtn, false);

                if (result.status) {
                    connectionInfo = result.data;
                    isConnected = true;
                    connectionStatus.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>Connected to ${hostIp}</span>
            `;
                    connectionStatus.className = 'connection-status connected';
                    showStatus(`Connected successfully to ${hostIp} as ${username}`, 'success');

                    // Set initial path to /home/username
                    currentPath = `/home/${username}`;
                    refreshFileList();

                    // Initialize terminal
                    initTerminal();

                    // Fetch disk usage
                    fetchDiskUsage();
                } else {
                    showStatus(`Connection failed: ${result.msg}`, 'error');
                }
            } catch (error) {
                setButtonLoading(connectBtn, false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Restrict navigation to home directory
        function navigateTo(path) {
            // Extract username from the current path
            const pathParts = currentPath.split('/');
            const username = pathParts.length >= 3 ? pathParts[2] : '';
            const homePath = `/home/${username}`;

            // Check if the requested path starts with /home/username
            if (!path.startsWith(homePath)) {
                showStatus(`Access restricted to ${homePath}`, 'error');
                return;
            }

            currentPath = path;
            refreshFileList();
        }

        // Modified navigateUp function with home directory restriction
        function navigateUp() {
            // Extract username from the current path
            const pathParts = currentPath.split('/');
            const username = pathParts.length >= 3 ? pathParts[2] : '';
            const homePath = `/home/${username}`;

            // Don't allow navigating above /home/username
            if (currentPath === homePath) {
                showStatus(`Cannot navigate above ${homePath}`, 'error');
                return;
            }

            setButtonLoading(upDirBtn, true);

            const parts = currentPath.split('/').filter(p => p);
            parts.pop();
            let newPath = '/' + parts.join('/');

            // Ensure we don't go above home directory
            if (!newPath.startsWith(homePath)) {
                newPath = homePath;
            }

            currentPath = newPath;

            refreshFileList().then(() => {
                setButtonLoading(upDirBtn, false);
            }).catch(() => {
                setButtonLoading(upDirBtn, false);
            });
        }

        // Modified createNewFolder function
        async function createNewFolder() {
            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            // Extract username from the current path
            const pathParts = currentPath.split('/');
            const username = pathParts.length >= 3 ? pathParts[2] : '';
            const homePath = `/home/${username}`;

            // Check if the current path is within home directory
            if (!currentPath.startsWith(homePath)) {
                showStatus(`Cannot create folders outside ${homePath}`, 'error');
                return;
            }

            const folderName = prompt('Enter folder name:');
            if (!folderName) return;

            const newPath = currentPath === '/'
                ? `/${folderName}`
                : `${currentPath}/${folderName}`;

            try {
                // Show loading state
                setButtonLoading(newFolderBtn, true);
                showStatus(`Creating folder "${folderName}"...`, '');

                const response = await fetch('/mkdir', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostIp: connectionInfo.hostIp,
                        username: connectionInfo.username,
                        path: newPath
                    })
                });

                const result = await response.json();

                // Hide loading state
                setButtonLoading(newFolderBtn, false);

                if (result.status) {
                    showStatus(`Folder "${folderName}" created successfully`, 'success');
                    refreshFileList();
                } else {
                    showStatus(`Failed to create folder: ${result.msg}`, 'error');
                }
            } catch (error) {
                setButtonLoading(newFolderBtn, false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Get file listing
        async function refreshFileList() {
            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            try {
                // Show loading state
                setButtonLoading(refreshBtn, true);
                setFileListLoading(true);
                showStatus(`Loading files from ${currentPath}...`, '');

                const response = await fetch('/listFiles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostIp: connectionInfo.hostIp,
                        username: connectionInfo.username,
                        location: currentPath
                    })
                });

                const result = await response.json();

                // Hide loading state
                setButtonLoading(refreshBtn, false);
                setFileListLoading(false);

                if (result.status) {
                    displayFiles(result.data);
                    currentPathDisplay.textContent = currentPath;
                    updateDirectoryStats(result.data);
                    showStatus(`Loaded ${result.data.length} items from ${currentPath}`, 'success');
                } else {
                    showStatus(`Failed to list files: ${result.msg}`, 'error');
                }
            } catch (error) {
                setButtonLoading(refreshBtn, false);
                setFileListLoading(false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Update directory statistics
        function updateDirectoryStats(files) {
            const dirs = files.filter(f => f.type === 'dir').length;
            const filesCount = files.filter(f => f.type === 'file').length;

            dirStats.textContent = `${dirs} ${dirs === 1 ? 'directory' : 'directories'}, ${filesCount} ${filesCount === 1 ? 'file' : 'files'}`;
        }

        // Fetch disk usage information
        async function fetchDiskUsage() {
            if (!isConnected) return;

            try {
                const response = await fetch('/getDf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostIp: connectionInfo.hostIp,
                        username: connectionInfo.username,
                        path: '/'
                    })
                });

                const result = await response.json();

                if (result.status) {
                    showStatus(`Disk usage information retrieved`, 'success');
                } else {
                    showStatus(`Failed to get disk usage: ${result.msg}`, 'error');
                }
            } catch (error) {
                console.error('Error fetching disk usage:', error);
            }
        }

        // Display files in the file list
        function displayFiles(files) {
            fileList.innerHTML = '';

            if (files.length === 0) {
                fileList.innerHTML = `
                          <div class="file-item">
                              <div class="file-info">
                                  <i class="fas fa-info-circle file-icon"></i>
                                  <span class="file-name">Empty directory</span>
                              </div>
                          </div>
                      `;
                return;
            }

            // Sort: directories first, then files alphabetically
            files.sort((a, b) => {
                if (a.type === 'dir' && b.type !== 'dir') return -1;
                if (a.type !== 'dir' && b.type === 'dir') return 1;
                return a.name.localeCompare(b.name);
            });

            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${file.type}`;

                let fileIcon, fileSize;

                if (file.type === 'dir') {
                    fileIcon = 'fa-folder';
                } else {
                    fileIcon = getFileIcon(file.name);
                    fileSize = formatFileSize(file.size);
                }

                const fileHtml = `
                          <div class="file-info">
                              <i class="fas ${fileIcon} file-icon"></i>
                              <div class="file-details">
                                  <span class="file-name">${file.name}</span>
                                  ${file.type === 'file' ? `<span class="file-meta">${fileSize} â€¢ ${file.mTime}</span>` : ''}
                              </div>
                          </div>
                          <div class="item-actions">
                              ${file.type === 'file' ? `
                                  <button class="btn btn-secondary download-btn">
                                      <i class="fas fa-download"></i>
                                  </button>
                              ` : ''}
                              <button class="btn btn-danger delete-btn">
                                  <i class="fas fa-trash-alt"></i>
                              </button>
                          </div>
                      `;

                fileItem.innerHTML = fileHtml;

                if (file.type === 'dir') {
                    fileItem.querySelector('.file-info').addEventListener('click', () => navigateTo(file.path));
                }

                if (file.type === 'file') {
                    fileItem.querySelector('.download-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        downloadFile(file.path);
                    });
                }

                fileItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(file.path);
                });

                fileList.appendChild(fileItem);
            });
        }

        // Get appropriate icon for file type
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();

            const iconMap = {
                'txt': 'fa-file-alt',
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint',
                'pptx': 'fa-file-powerpoint',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'gif': 'fa-file-image',
                'zip': 'fa-file-archive',
                'rar': 'fa-file-archive',
                'tar': 'fa-file-archive',
                'gz': 'fa-file-archive',
                'py': 'fa-file-code',
                'js': 'fa-file-code',
                'html': 'fa-file-code',
                'css': 'fa-file-code',
                'php': 'fa-file-code',
                'c': 'fa-file-code',
                'cpp': 'fa-file-code',
                'java': 'fa-file-code',
                'sh': 'fa-file-code',
                'mp3': 'fa-file-audio',
                'wav': 'fa-file-audio',
                'mp4': 'fa-file-video',
                'avi': 'fa-file-video',
                'mov': 'fa-file-video'
            };

            return iconMap[extension] || 'fa-file';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';

            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Navigate to a directory
        function navigateTo(path) {
            currentPath = path;
            refreshFileList();
        }

        // Navigate up one directory
        function navigateUp() {
            if (currentPath === '/') return;

            setButtonLoading(upDirBtn, true);

            const parts = currentPath.split('/').filter(p => p);
            parts.pop();
            currentPath = '/' + parts.join('/');

            refreshFileList().then(() => {
                setButtonLoading(upDirBtn, false);
            }).catch(() => {
                setButtonLoading(upDirBtn, false);
            });
        }

        // Create a new folder
        async function createNewFolder() {
            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            const folderName = prompt('Enter folder name:');
            if (!folderName) return;

            const newPath = currentPath === '/'
                ? `/${folderName}`
                : `${currentPath}/${folderName}`;

            try {
                // Show loading state
                setButtonLoading(newFolderBtn, true);
                showStatus(`Creating folder "${folderName}"...`, '');

                const response = await fetch('/mkdir', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostIp: connectionInfo.hostIp,
                        username: connectionInfo.username,
                        path: newPath
                    })
                });

                const result = await response.json();

                // Hide loading state
                setButtonLoading(newFolderBtn, false);

                if (result.status) {
                    showStatus(`Folder "${folderName}" created successfully`, 'success');
                    refreshFileList();
                } else {
                    showStatus(`Failed to create folder: ${result.msg}`, 'error');
                }
            } catch (error) {
                setButtonLoading(newFolderBtn, false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Download a file
        async function downloadFile(path) {
            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            // Extract filename from path
            const filename = path.split('/').pop();

            // Create a download button element to show loading state
            const downloadBtn = event.currentTarget;
            const originalHTML = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<div class="loader"></div>';
            downloadBtn.disabled = true;

            showStatus(`Downloading ${filename}...`, '');

            const downloadParams = {
                hostIp: connectionInfo.hostIp,
                username: connectionInfo.username,
                remotePath: path
            };

            try {
                const response = await fetch('/getFile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(downloadParams)
                });

                // Restore button
                downloadBtn.innerHTML = originalHTML;
                downloadBtn.disabled = false;

                if (response.ok) {
                    // Create a temporary link to download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                    showStatus(`Downloaded ${filename} successfully`, 'success');
                } else {
                    const data = await response.json();
                    showStatus(`Download failed: ${data.msg}`, 'error');
                }
            } catch (error) {
                // Restore button
                downloadBtn.innerHTML = originalHTML;
                downloadBtn.disabled = false;

                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Delete a file or directory
        async function deleteFile(path) {
            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${path}"?`)) {
                return;
            }

            // Get the delete button
            const deleteBtn = event.currentTarget;
            const originalHTML = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<div class="loader"></div>';
            deleteBtn.disabled = true;

            try {
                showStatus(`Deleting ${path}...`, '');

                const response = await fetch('/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hostIp: connectionInfo.hostIp,
                        username: connectionInfo.username,
                        path: path
                    })
                });

                // Restore button
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.disabled = false;

                const result = await response.json();

                if (result.status) {
                    showStatus(`Deleted ${path} successfully`, 'success');
                    refreshFileList();
                } else {
                    showStatus(`Failed to delete: ${result.msg}`, 'error');
                }
            } catch (error) {
                // Restore button
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.disabled = false;

                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Upload a file
        async function uploadFile(e) {
            e.preventDefault();

            if (!isConnected) {
                showStatus('Not connected to any server', 'error');
                return;
            }

            const fileInput = document.getElementById('fileUpload');
            if (!fileInput.files.length) {
                showStatus('Please select a file to upload', 'error');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Show loading state
                setButtonLoading(uploadBtn, true);
                showStatus(`Uploading ${file.name} to ${currentPath}...`, '');

                const uploadParams = {
                    hostIp: connectionInfo.hostIp,
                    username: connectionInfo.username,
                    location: currentPath
                };

                const response = await fetch('/uploadfile', {
                    method: 'POST',
                    headers: {
                        'upload-params': JSON.stringify(uploadParams),
                        'file-size': file.size.toString()
                    },
                    body: formData
                });

                const result = await response.json();

                // Hide loading state
                setButtonLoading(uploadBtn, false);

                if (result.status) {
                    showStatus(`Uploaded ${file.name} successfully`, 'success');
                    refreshFileList();
                } else {
                    showStatus(`Upload failed: ${result.msg}`, 'error');
                }
            } catch (error) {
                setButtonLoading(uploadBtn, false);
                showStatus(`Error: ${error.message}`, 'error');
            }

            // Reset file input
            fileInput.value = '';
        }

        // Show status message
        function showStatus(message, type = '') {
            const statusArea = document.getElementById('statusArea');
            const statusMsg = document.createElement('p');
            statusMsg.textContent = message;

            if (type === 'success') {
                statusMsg.className = 'success-message';
                statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else if (type === 'error') {
                statusMsg.className = 'error-message';
                statusMsg.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            }

            statusArea.appendChild(statusMsg);
            statusArea.scrollTop = statusArea.scrollHeight;

            // Also log to console for debugging
            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log(message);
            } else {
                console.info(message);
            }
        }
    </script>
</body>

</html>
